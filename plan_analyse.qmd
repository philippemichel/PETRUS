---
subtitle: "Plan d'analyse statistique"
---

```{r info}
rm(list=ls())
library("baseph")
library("tidyverse")
library("boot")
library("labelled")
library("ggsci")
# sessionInfo()
```

# Généralités

Le risque $\alpha$ retenu sera de 0,05 & la puissance de 0,8.

## Taille de l'échantillon

Parmi les cas suspects d’\gls{acg} inclus dans l’étude, les cas d'\gls{acg} positif et \gls{acg} négatif seront séparés et la mesure du marqueur diagnostique « \gls{dgno}) » sera réalisée pour chaque sujet et ce afin de calculer un intervalle de confiance unilatéral de 97,5 % pour la limite inférieure de l'aire sous la courbe ROC
(\gls{auc}) du marqueur.

La valeur de l'\gls{auc} de l'échantillon est supposée être de 0,8 (bon marqueur).
La méthode de calcul de l'erreur standard donnée par Hanley et McNeil (1982) sera
utilisée pour calculer la limite de l'intervalle de confiance.

Pour produire un intervalle de confiance avec une distance de l'\gls{auc} de \num{0.075} à la limite inférieure, le nombre de sujets nécessaires sera de 57 dans le groupe \gls{acg} positif et de 133 dans le groupe \gls{acg} négatif (prévalence de l’\gls{acg} positif parmi les cas suspects = 0,3) soit 190 patients au total.

Un nombre important de patients a une atteint bilatérale, l’unité statistique sera l’œil et non pas le patient. Cela ne modifie pas l’effectif, ainsi la précision obtenue sera supérieure à celle du calcul d’effectif. Le modèle utilisé tiendra compte de la répétition des mesures (mesures non indépendantes, effet aléatoire).

## Données manquantes

Le décompte des données manquantes sera réalisé & présenté par un tableau ou un graphique. Les variables comportant trop de données manquantes ou non utilisables ne seront pas prises en compte après validation par le promoteur. Les cas où la mesure du \gls{dgno} n'est pas notée seront exclus. 

#  Phase 1

*Validation de la reproductibilité de la méthode en comparant les mesures réalisées par trois cliniciens.*

La différence du \gls{dgno} entre les sujets sains & malades serait selon la littérature de \qty{2}{\mm}. On prend donc comme écart de mesure acceptable entre deux cliniciens \qty{1}{\mm}. Les cas de divergences supérieures seront notées en précisant s'il s'agit de résultats dans la zone *saine*, *malade* ou introduisant un doute.

Le diagramme de Bland & Altmann est classiquement utilisé pour présenter des mesures réalisées par deux cliniciens mais ne s'applique pas pour plus de cliniciens.  Les diagrammes de Bland & Altmann seront tracés pour chaque paire de cliniciens (trois diagrammes) Les résultats seront présentés par un diagramme présentant en abscisse la mesure & en ordonnée la moyenne, les examinateurs étant différentiés par la couleur du point (graphique @fig-ba1). Les différences seront évaluées par la méthode proposée par S. Möller [@moller11] sur un diagramme avec en abscisse la moyenne des mesures pour chaque sujet & en ordonnée l'écart-type entre les trois mesures -- (graphique @fig-ba2). 

```{r}
#| label: prepa_bland

 n <- 60
A <- (rnorm(n,20,1)*1)/15
B <- (rnorm(n,20,1.2)*1)/15
C <- (rnorm(n,20,1)*1 + rnorm(n,1,1.1) * 1)/15

zz <- tibble(A,B,C) |> 
rowwise() |> 
mutate(moy = mean(c(A,B,C))) |> 
mutate(ety = sd(c(A,B,C)))
```

```{r}
#| label: fig-ba1
#| fig-cap: titre


aa <- zz |> 
  pivot_longer(c(A,B,C)) 
maa <- mean(aa$value)
saa <- sd(aa$value)*1.96
var_label(aa) <- c("Moyenne par sujet","Écart-type par sujet" ,"Examinateur","Mesure")

aa |> 
  ggplot() + 
    aes(x = moy, y = value, col = name) +
    geom_point() +
    geom_hline(yintercept = maa) +
    geom_hline(yintercept = c(maa-saa,maa +saa), linetype = 6) +
    labs(title = "Mesures par examinateur",
        subtitle = "Données fictives",
        x = "Moyennes des mesures",
        y = "Mesures",
        caption = "Pour chaque cas les trois mesures sont représentées par trois points de couleur différente selon l'examinateur.",
        color = "Examinateur") +
    theme_light() +
    scale_fill_jama() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      legend.title = element_text(size = 12),
      axis.title.y = element_text(
        size = 12,
        angle = 90,
        vjust = .5
      ),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
    )
```

```{r}
#| label: fig-ba2
#| fig-cap: Écart-type des mesures

msd <- mean(zz$ety)
cib <- msd-sd(zz$ety)*1.96
cih <- msd+sd(zz$ety)*1.96

zz |> 
  ggplot() + 
    aes(x = moy, y = ety) +
    geom_point() +
  geom_hline(yintercept = msd, linetype = 1) +
  geom_hline(yintercept = c(cib, cih), linetype = 5) +
      labs(title = "Différences inter examinateurs",
        subtitle = "Données fictives",
        x = "Moyennes des mesures",
        y = "Écart-type des Mesures par cas",
        caption = "",
        color = "Examinateur") +
    theme_light() +
    scale_fill_jama() +
    theme(
      plot.title = element_text(size = 14, face = "bold"),
      plot.subtitle = element_text(size = 12),
      axis.title.x = element_text(size = 12),
      legend.title = element_text(size = 12),
      axis.title.y = element_text(
        size = 12,
        angle = 90,
        vjust = .5
      ),
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
    )


```



Le \gls{icc} inter-évaluateurs (modèle à deux facteurs à effets aléatoires --- two-way random) sera calculé (package `irr` [@irr]). Un \gls{icc} > \num{0.75} sera considéré comme correct.

Cette première phase concerne 60 patients. 

```{r}
#| eval: false

library("irr")
tt |> 
icc(
  model = "twoway", 
  type = "agreement", unit = "single"
  )
```

# Phase 2

## Objectif principal

La validation du marqueur sera obtenue par l'étude de l'\gls{auc} sur une courbe ROC calculée avec :

- Valeur mesurée : le \gls{dgno} mesuré par le clinicien expert;
- Diagnostic de référence : celui réalisé par le clinicien expert à six mois (deux classes : malade/sain).

Une limite acceptable sera une \gls{auc} > \num{0.8}. 

# Objectifs secondaires

## Objectif 1

*Évaluer la fiabilité des mesures du \gls{dgno} à l’échographie.*

Cet objectif reprend les objectifs de la phase I (section \ref{phase-1}). 

## Objectif 2
*Évaluer les performances diagnostiques du \gls{dgno} dans l’\gls{acg}.*

La courbe ROC sera tracée (package `pROC` [@proc]). 

Le point d’inflexion de la courbe ROC qui permet de définir le seuil le plus discriminant entre normal & pathologique sera recherché visuellement tout d'abord sur la courbe puis confirmé par les calculs de spécificité pour des valeurs proches. 

Les indicateurs classiques de performance diagnostiques seront présentés (sensibilité, spécificité, valeur prédictive positive, valeur prédictive négative, rapport de vraisemblance positive, rapport de vraisemblance négative) (package `epiDisplay` [@epid]) calculés avec un seuil pathologique à \qty{2}{\mm} reconnu dans la littérature puis avec le seuil mis en évidence sur notre échantillon. 


## Objectif 3
*Étudier l’évolution du \gls{dgno} sous traitement entre M0 et M6 pour les patients présentant une \gls{acg}.*

La mesure de la \gls{dgno} sera réalisée à M0 & M6 pour chaque patient. Les mesures seront présentées en moyenne, écart-type & intervalle de confiance aux deux temps puis comparées par un test de Student pour séries appariées. 

## Objectif 4
*Évaluation exploratoire du \gls{dgno} en fonction de la présence ou non d’une \gls{acg} extra crânienne.*

Les patients seront classés en sous groupes à six mois par le clinicien : \gls{acg}
crânienne, \gls{acg} extra-crânienne, \gls{acg} négatif. Les mesures de la \gls{dgno} seront comparées entre les trois groupes (\gls{anova}) puis en insistant sur la comparaison \gls{acg} crânienne vs \gls{acg} extra-crânienne (test du t de Student).

## Objectif 5
*Évaluation exploratoire du \gls{dgno} selon la présence ou non d’une \gls{acg} avec atteinte visuelle.*

Les patients seront classés en sous groupes à six mois par le clinicien : \gls{acg} avec atteinte visuelle, \gls{acg} sans atteinte visuelle, \gls{acg} négatif. Les mesures de la \gls{dgno} seront comparées entre les trois groupes (\gls{anova}) puis en insistant sur la comparaison \gls{acg} avec
atteinte visuelle, \gls{acg} sans atteinte visuelle, (test du t de Student).

## Objectif 6
*Étudier la faisabilité de l’échographie comme outil diagnostic de la maladie de Horton.*

Une description de la population sera réalisée (critères cliniques, sociaux\dots) avec recherche de différence sur la mesure du \gls{dgno}. Si des critères semblent influer cette mesure une analyse en régression logistique sera réalisée : malades/sains vs \gls{dgno} & tous les critères démographiques ayant un p < \num{0.2}. Le modèle sera affiné par une analyse en step-by-step descendant basé sur l'\textsc{aic}.

# Technique {.appendix}

L'analyse statistique sera réalisée avec le logiciel **R**[@rstat] & divers packages. Outre ceux cités dans le texte ou utilisera en particulier `tidyverse` [@tidy] & `baseph` [@baseph].

Un dépôt GitHub sera utilisé qui ne comprendra que le code & non les données ou résultats. Au besoin un faux tableau de données sera présenté pour permettre des tests.

<https://github.com/philippemichel/PETRUS>


\printglossaries

\addcontentsline{toc}{chapter}{C. Bibliographie}
