---
subtitle: "Double lecture & technique V0.3 -- Données incomplètes"
cache: false
---
::: panel-tabset

```{r}
#| label: setup

library("tidyverse")
library("janitor")
library("labelled")
library("baseph")
library("plotly")
library("gtsummary")
#
load("datas/dlect.RData")

classeur <- "double_lecture.ods"
expx <- FALSE
if (expx) {
  file.create(classeur)
  file.remove(classeur)
  write_ods(iris, classeur)
}

# sessionInfo()
theme_gtsummary_language(language = "fr", decimal.mark = ",")
theme_gtsummary_journal(journal = "jama")
options(OutDec = ",")
ptest <- list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")
ptest2 <- list(all_continuous() ~ "paired.t.test", all_categorical() ~ "chisq.test")
stt <- list(
  all_continuous() ~ "{mean} ({sd})",
  all_categorical() ~ "{n}/{N} ({p}%)"
)
```

# Valeurs brutes

Le premier tableau donne les différences entre la mesure 1 & la mesure 2 pour les mêmes coupes, par expert pour les nerfs & les gaines.

```{r}
#| label: tbl-valeurs
#| tbl-cap: Mesures des experts

zz <- tt |> 
  mutate(coupe2 = paste(coupe, "_",expert)) |> 
  dplyr::select(relecture:coupe2) |> 
  pivot_wider(names_from = relecture, values_from = nerf_dt:gaine_gch) |> 
  mutate(dif_ndt = abs(nerf_dt_2 - nerf_dt_1)) |>
  mutate(dif_ngch = abs(nerf_gch_2 - nerf_gch_1)) |>
  mutate(dif_gdt = abs(gaine_dt_2 - gaine_dt_1)) |>
  mutate(dif_ngch = abs(gaine_gch_2 - gaine_gch_1)) 

nom <- str_split_fixed(zz$coupe2,pattern = "_",n = 2)
nom <- rep(nom[,2],2)
dnf <- c(zz$dif_ndt, zz$dif_ngch)
dgn <- c(zz$dif_gdt, zz$dif_ngch)
zz <- tibble(nom,dnf,dgn) 
var_label(zz) <- c("Nom","Nerf optique", "Gaine du nerf optique")
zz |> 
  tbl_summary(by = nom,
              type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")
  ) |> 
 # add_ci() |> 
  add_p() |> 
  modify_header(label = "**Différence des mesures**") |> 
      add_overall(col_label = "**Total**") |> 
    bold_labels() |>
    bold_p() |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "dif1", lg = FALSE)
```

::: {.callout-warning}
La colonne **Total** est (provisoirement) fausse. 
:::

## ICC

On calcule l'ICC inter-évaluateurs (modèle à un facteurs à effets aléatoires — one-way random) pour vérifier qu'il n'y a pas de différence entre les trois experts. 

::: {.callout-warning}
Le calcul n'aura de sens qu'avec les résultats de plusieurs lecteurs. Les diffrences demeurent faibles si on prend comme référence le seuil à 1 mm pour valider un lecteur.   
:::

```{r}
#| eval: false

library("irr")
aa <- zz |> 
pivot_longer(cols = c(dnf,dgn), names_to = "mesure", values_to = "dif") |> 
  mutate(nom= as.factor(nom)) |>
  mutate(id = 1:120) |> 
  dplyr::select(!mesure) |> 
  pivot_wider(names_from = nom, 
              values_from = dif)  |> 
  dplyr::select(!id)



icc(aa,
  model = "oneway", 
  type = "agreement", unit = "single"
  )
```


# Technique

## Comparaison des deux techniques

On compare ici les résultats de deux technique de mesure :

- Technique classique
- Mesure à l'interface du vitré

Cette comparaison permet de mettre en évidence des différences entre les techniques mais absolument pas de valider ou non la nouvelle technique. 

```{r}
#| label: tbl-diftech
#| tbl-cap: Différences selon la technique

dd <- tc |>
  dplyr::select(coupe, technique, expert, nfdt, gndt) |>
  mutate(id = paste0(coupe, expert, "-dt"))
names(dd) <- c("coupe", "technique", "expert", "nerf", "gaine", "id")
#
gg <- tc |>
  dplyr::select(coupe, technique, expert, nfgch, gngch) |>
  mutate(id = paste0(coupe, expert, "-gch"))
names(gg) <- c("coupe", "technique", "expert", "nerf", "gaine", "id")
dg <- rbind(dd, gg)
var_label(dg$nerf) <- "Diamètre nerf optique (mm)"
var_label(dg$gaine) <- "Diamètre gaine du nerf optique (mm)"
#
dg |> 
  dplyr::select(technique, nerf,gaine,id) |>
  tbl_summary(by = technique,
              include = -id,
              type = all_continuous() ~ "continuous2",
              statistic = all_continuous() ~ c(
                "{mean} ± {sd}",
                "{min}, {max}"),, 
              missing = "no")|>
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Technique de mesure**") |>
  add_p(
    test = list(all_continuous() ~ "paired.t.test"),
    group = id
  ) |> 
   modify_header(label = "****") |>
  bold_labels() |> 
  bold_p() |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "diftech", lg = FALSE)
```

Pour la mesure du diamètre du nerf optique, la mesure par la technique *habituelle* est systématiquement plus haute (d'environ 0,2 mm) que par la technique *Interface vitrée*. Pour la mesure de la gaine du nerf optique les deux méthodes donnent des résultats très proches. Dans les deux cas, dispersions des mesures est la même, c'est à dire la qualité des mesures est la même. 

```{r}
#| label: fig-techbland-nerf
#| fig-cap: Comparaison des deux techniques (nerf)

hh <- dg |> 
  dplyr::filter(technique == "Habituelle") |> 
  dplyr::select(nerf) |> 
  rename(habituel = nerf)
nn <- dg |> 
  dplyr::filter(technique != "Habituelle") |> 
  dplyr::select(nerf) |> 
   rename(interface = nerf)
#
ff <- tibble(hh,nn) |> 
mutate(difx = habituel-interface) |>
  drop_na(difx) |> 
  ggplot() +
  aes(x = habituel, y = difx) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dotdash", linewidth = 0.5,
             color = "grey50") +
  labs(title = "Diamètre du nerf optique",
      subtitle = "Diagramme de Bland-Altman",
      x = "mesure habituelle (mm)",
      y = "Dmesure habituelle - mesure à l'interface",
      caption = "",
      fill = "") +
  theme_light() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 90,
      vjust = .5
    ),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  legend.position = "right"
  )

ggplotly(ff)
```

```{r}
#| label: fig-techbland-gaine
#| fig-cap: Comparaison des deux techniques (gaine du nerf)

hh <- dg |> 
  dplyr::filter(technique == "Habituelle") |> 
  dplyr::select(gaine) |> 
  rename(habituel = gaine)
nn <- dg |> 
  dplyr::filter(technique != "Habituelle") |> 
  dplyr::select(gaine) |> 
   rename(interface = gaine)
#
ff <- tibble(hh,nn) |> 
mutate(difx = habituel-interface) |>
  drop_na(difx) |> 
  ggplot() +
  aes(x = habituel, y = difx) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dotdash", linewidth = 0.5,
             color = "grey50") +
  labs(title = "Diamètre de la gaine du nerf optique",
      subtitle = "Diagramme de Bland-Altman",
      x = "mesure habituelle (mm)",
      y = "mesure habituelle - mesure à l'interface",
      caption = "",
      fill = "") +
  theme_light() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 90,
      vjust = .5
    ),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  legend.position = "right"
  )

ggplotly(ff)
```
:::
