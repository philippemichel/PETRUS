---
subtitle: "Double lecture & technique V1.1"
cache: false
prefer-html: true
---
::: panel-tabset

# Introduction

::: {.callout-tip title="Évaluation de la gaine du nerf optique par échographie dans l'Artérite à Cellules géantes"}

Recherche non interventionnelle ne comportant aucun risque ni contrainte

Étude diagnostique non interventionnelle, prospective multicentrique



**Investigateur Coordonnateur** <br>Omar AL TABAA --- Rhumatologie 
Hôpital NOVO (Site de Pontoise)

**Comité scientifique**<br>
Maxime SANSOM --- Service de médecine interne CHU Dijon<br>
Sébastien OTTAVIANI --- Service de rhumatologie hôpital Bichat
(Paris)<br>
Olivier ESPITIA --- Service de médecine vasculaire CHU Nantes

**Chef de projet** <br>Mathilde WLODARCZYK

**Méthodologiste**<br> Chrystelle VIDAL --- GIRCI Île de France

**Data-manager**<br>Nathanaël CHARRIER

**Statisticien**<br>Philippe MICHEL
:::


```{r}
#| label: setup

library("tidyverse")
library("janitor")
library("labelled")
library("baseph")
library("readODS")
library("plotly")
library("gtsummary")
#
load("datas/dlect.RData")

classeur <- "double_lecture.ods"
expx <- FALSE
if (expx) {
  file.create(classeur)
  file.remove(classeur)
  write_ods(iris, classeur)
}

# sessionInfo()
theme_gtsummary_language(language = "fr", decimal.mark = ",")
theme_gtsummary_journal(journal = "jama")
options(OutDec = ",")
ptest <- list(all_continuous() ~ "t.test", all_categorical() ~ "chisq.test")
ptest2 <- list(all_continuous() ~ "paired.t.test", all_categorical() ~ "chisq.test")
stt <- list(
  all_continuous() ~ "{mean} ({sd})",
  all_categorical() ~ "{n}/{N} ({p}%)"
)

```

# Valeurs brutes

Le premier tableau donne les différences entre la mesure 1 & la mesure 2 pour les mêmes coupes, par expert pour les nerfs & les gaines.

```{r}
#| label: tbl-valeurs
#| tbl-cap: Mesures des experts

zz <- tt |> 
  mutate(coupe2 = paste(coupe, "_",expert)) |> 
  dplyr::select(nerf_dt:coupe2) |> 
  pivot_wider(names_from = relecture, values_from = nerf_dt:gaine_gch) |> 
  mutate(dif_ndt = abs(nerf_dt_2 - nerf_dt_1)) |>
  mutate(dif_ngch = abs(nerf_gch_2 - nerf_gch_1)) |>
  mutate(dif_gdt = abs(gaine_dt_2 - gaine_dt_1)) |>
  mutate(dif_ngch = abs(gaine_gch_2 - gaine_gch_1)) 

nom <- str_split_fixed(zz$coupe2,pattern = "_",n = 2)
nom <- rep(nom[,2],2)
dnf <- c(zz$dif_ndt, zz$dif_ngch)
dgn <- c(zz$dif_gdt, zz$dif_ngch)
zz <- tibble(nom,dnf,dgn) 
var_label(zz) <- c("Nom","Nerf optique", "Gaine du nerf optique")
zz |> 
  tbl_summary(by = nom,
              type = all_continuous() ~ "continuous2",
    statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")
  ) |> 
 # add_ci() |> 
  add_p() |> 
  modify_header(label = "**Différence des mesures**") |> 
      add_overall(col_label = "**Total**") |> 
    bold_labels() |>
    bold_p() |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "dif1", lg = FALSE)
```

Il n'y a aps de différence significative entre les mesures des trois experts. 


## Mesures abberrantes

On considère comme non concordante une différence entre les deux mesures de plus de 1 mm.

```{r}
#| label: tbl-aberr
#| tbl-cap: Mesures abberrantes

qq <- zz |> 
  mutate(nerf_aberr = if_else(dnf > 1, "Oui", "Non")) |> 
  mutate(gaine_aberr = if_else(dgn > 1, "Oui", "Non")) |> 
  dplyr::select(-dnf, -dgn)
var_label(qq) <- c("Nom","Nerf optique", "Gaine du nerf optique")
qq |>
  tbl_summary(by = nom, missing = "no") |> 
      add_overall(col_label = "**Total**") |> 
    bold_labels() |>
   modify_header(label = "**Mesures non concordantes**") |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "abberrant", lg = FALSE)
```

Il y a un patient avec une mesure *fausse* pour le nerf optique et pour la gaine du nerf optique.

## ICC

On calcule l'ICC inter-évaluateurs (modèle à un facteurs à effets aléatoires — one-way random) pour vérifier qu'il n'y a pas de différence entre les trois experts. 

::: {.callout-warning}
Le calcul n'aura de sens qu'avec les résultats de tous les lecteurs.  
:::

```{r}
#| label: icc
#| eval: false

library("irr")
aan <-  c(tt$nerf_dt,tt$nerf_gch,tt$gaine_dt,tt$gaine_gch)
aax <- rep(tt$expert,4)
id = (1:length(aan))
aa <- tibble(id = id, mesure = aan, expert = aax) |> 
  pivot_wider(names_from = expert, values_from = mesure) |> 
  drop_na()

icc(aa,
  model = "oneway", 
  type = "agreement", unit = "single"
  )
```


# Technique

## Comparaison des deux techniques

On compare ici les résultats de deux technique de mesure :

- Technique classique
- Mesure à l'interface du vitré

Cette comparaison permet de mettre en évidence des différences entre les techniques mais absolument pas de valider ou non la nouvelle technique. 

```{r}
#| label: tbl-diftechnf
#| tbl-cap: Différences selon la technique (nerf)

tc$id = (tc$id = paste0(tc$coupe,tc$centre, tc$expert))

tec <- c(tc$technique, tc$technique)
lect <- c(tc$expert,tc$expert)
nerf <- c(tc$nfdt, tc$nfgch)
id <- c(paste0(tc$id,"a"), paste0(tc$id,"b"))
zzn <- tibble(id = id,technique=tec, expert=lect, nerf=nerf) |> 
  dplyr::select(-expert) |> 
  pivot_wider(names_from = technique, values_from = nerf) |> 
  drop_na(Habituelle,`Interface vitré`) |> 
  pivot_longer(cols = c(Habituelle,`Interface vitré`), names_to = "technique",
               values_to = "nerf") 

zzn |> 
  tbl_summary(by = technique, include = -id,
              type = all_continuous() ~ "continuous2",
                  statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
  add_p(
    test = list(all_continuous() ~ "paired.t.test"),
    group = id
  ) |> 
   modify_header(label = "** **") |>
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Technique de mesure**") |>
  bold_labels() |> 
  bold_p() |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "diftechnf", lg = FALSE)
```

```{r}
#| label: tbl-diftechgn
#| tbl-cap: Différences selon la technique (gaine du nerf)

tc$id = (tc$id = paste0(tc$coupe,tc$centre, tc$expert))

tec <- c(tc$technique, tc$technique)
lect <- c(tc$expert,tc$expert)
gaine <- c(tc$gndt, tc$gndt)
id <- c(paste0(tc$id,"a"), paste0(tc$id,"b"))
zzg <- tibble(id = id,technique=tec, expert=lect, gaine=gaine) |> 
  pivot_wider(names_from = technique, values_from = gaine) |> 
  drop_na(Habituelle,`Interface vitré`) |> 
  pivot_longer(cols = c(Habituelle,`Interface vitré`), names_to = "technique",
               values_to = "gaine") 

zzg |> 
  tbl_summary(by = technique, include = -c(id, expert),
              type = all_continuous() ~ "continuous2",
                  statistic = all_continuous() ~ c(
      "{mean} ± {sd}",
      "{min}, {max}")) |> 
  add_p(
    test = list(all_continuous() ~ "paired.t.test"),
    group = id
  ) |> 
   modify_header(label = "** **") |>
  modify_spanning_header(c("stat_1", "stat_2") ~ "**Technique de mesure**") |> 
  bold_labels() |> 
  bold_p() |> 
  pexptabph(exp = expx, nomfich = classeur, nomsheet = "diftechgn")
```

Pour la mesure du diamètre du nerf optique comme de la gaine, la mesure par la technique *habituelle* est systématiquement plus haute (d'environ 0,2 mm) que par la technique *Interface vitrée*. Par contre la dispersion est la même, aucune des deux techniques ne semble donc avoir de meilleurs résultats. 

```{r}
#| label: fig-techbland-nerf
#| fig-cap: Comparaison des deux techniques (nerf)
ff <- zzn |> 
  pivot_wider(names_from = technique, values_from = nerf) |>
  mutate(différence = Habituelle - `Interface vitré`) |> 
  ggplot() +
  aes(x = Habituelle, y = différence) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dotdash", linewidth = 0.5,
             color = "grey50") +
  labs(title = "Diamètre du nerf optique",
      subtitle = "Diagramme de Bland-Altman",
      x = "mesure habituelle (mm)",
      y = "mesure habituelle - à l'interface du vitré",
      caption = "",
      fill = "") +
  theme_light() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 90,
      vjust = .5
    ),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  legend.position = "right"
  )

ggplotly(ff)
```

```{r}
#| label: fig-techbland-gaine
#| fig-cap: Comparaison des deux techniques (gaine du nerf)

ff <- zzg |> 
  pivot_wider(names_from = technique, values_from = gaine) |>
  mutate(différence = Habituelle - `Interface vitré`) |> 
  ggplot() +
  aes(x = Habituelle, y = différence) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dotdash", linewidth = 0.5,
             color = "grey50") +
  labs(title = "Diamètre de la gaine du nerf optique",
      subtitle = "Diagramme de Bland-Altman",
      x = "mesure habituelle (mm)",
      y = "mesure habituelle - à l'interface du vitré",
      caption = "",
      fill = "") +
  theme_light() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    legend.title = element_text(size = 12),
    axis.title.y = element_text(
      size = 12,
      angle = 90,
      vjust = .5
    ),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  legend.position = "right"
  )

ggplotly(ff)
```

:::
